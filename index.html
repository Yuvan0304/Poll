<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inter-House Poll</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef3fb;
    --card:#ffffff;
    --accent:#f7dcb0;
    --accent-border:#f0a63a;
    --green:#2fb871;
    --blue:#2d86ff;
    --red:#eb4343;
    --yellow:#f0a000;
    --muted:#6b7280;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,var(--bg) 0%, #f7fbff 100%);display:flex;align-items:center;justify-content:center;padding:28px;}
  .wrap{width:100%;max-width:420px;margin:0 auto;}
  .card{
    background:var(--card);
    border-radius:18px;
    box-shadow:0 18px 40px rgba(18,38,63,0.08);
    padding:26px;
  }
  h1{font-size:34px;margin:0 0 6px 0;font-weight:800;color:#111827;}
  p.lead{margin:0 0 18px 0;color:var(--muted);font-size:15px;}
  .note{
    background:linear-gradient(180deg,#fff6e8,#fff0d6);
    border-left:6px solid var(--accent-border);
    padding:14px 14px;
    border-radius:12px;
    margin-bottom:18px;
    color:#5a4633;
    box-shadow: 0 8px 18px rgba(240,166,58,0.08);
  }
  .subtitle{color:var(--muted);text-align:center;margin:12px 0 18px;}
  .btn{
    width:100%;
    border-radius:12px;
    padding:14px 16px;
    margin:10px 0;
    font-weight:700;
    font-size:16px;
    color:#fff;
    border:none;
    cursor:pointer;
    box-shadow:0 10px 24px rgba(16,24,40,0.06);
  }
  .btn-green{background:var(--green);}
  .btn-blue{background:var(--blue);}
  .btn-red{background:var(--red);}
  .btn-yellow{background:var(--yellow); color:#111;}
  .votes{margin-top:18px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;font-size:14px}
  .results{margin-top:14px;border-radius:12px;padding:12px;background:#fafafa;border:1px solid rgba(16,24,40,0.03);display:none}
  .result-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(16,24,40,0.04);}
  .result-row:last-child{border-bottom:0;}
  .bar{height:10px;border-radius:8px;background:rgba(0,0,0,0.06);overflow:hidden;margin-left:12px;flex:1;}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg, rgba(0,0,0,0.12), rgba(0,0,0,0.05));}
  .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .row{display:flex;gap:12px;align-items:center}
  #votedMsg{display:none;margin:18px 0;padding:12px;border-radius:10px;background:#ecfdf5;border:1px solid #34d399;color:#065f46;align-items:center}
  #votedMsg span{margin-left:8px}
  @media (max-width:420px){
    body{padding:18px;}
    h1{font-size:28px}
    .card{padding:20px;border-radius:16px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">Inter-House Poll</h1>
      <p class="lead">Which House Display did you like the best?</p>

      <div class="note" id="note">Vote for the House Display you liked best — not your child’s house.</div>

      <p class="subtitle">Choose your favourite house below:</p>

      <button class="btn btn-green" data-option="Green">Green House (Mithila)</button>
      <button class="btn btn-blue" data-option="Blue">Blue House (Nalanda)</button>
      <button class="btn btn-red" data-option="Red">Red House (Takshashila)</button>
      <button class="btn btn-yellow" data-option="Yellow">Yellow House (Vikramshila)</button>

      <div id="votedMsg" role="status">✅ <span id="votedText">You've already voted. Thank you!</span></div>

      <div class="votes">
        <div id="votesText">Votes: 0</div>
        <button id="refreshBtn" style="background:#2563eb;color:#fff;border-radius:10px;padding:6px 10px;border:none;cursor:pointer">Refresh</button>
      </div>

      <div class="results" id="resultsArea" aria-live="polite">
        <!-- result rows inserted here -->
      </div>

      <div class="footer">Made by YuvanSankarRaja S</div>
    </div>
  </div>

<script type="module">
  /************************************************
   *  FIREBASE CONFIG - KEEP YOUR EXISTING VALUES
   ************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBRxGX2ySr1gwNP2I728IGXwTWzBTxGGlk",
    authDomain: "poll-ysr.firebaseapp.com",
    databaseURL: "https://poll-ysr-default-rtdb.firebaseio.com/",
    projectId: "poll-ysr",
    storageBucket: "poll-ysr.firebasestorage.app",
    messagingSenderId: "724261938489",
    appId: "1:724261938489:web:7d8f908dc8ade2698b74e8"
  };

  const hasConfig = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.databaseURL;

  // DOM refs
  const buttons = document.querySelectorAll('.btn');
  const votesText = document.getElementById('votesText');
  const resultsArea = document.getElementById('resultsArea');
  const refreshBtn = document.getElementById('refreshBtn');
  const votedMsg = document.getElementById('votedMsg');
  const votedText = document.getElementById('votedText');

  // simple option keys
  const OPTIONS = ['Green','Blue','Red','Yellow'];

  // local states
  let db = null;
  let auth = null;
  let currentUid = null;
  let hasVotedLocal = !!localStorage.getItem('poll_voted'); // quick local guard

  // If config missing, UI still works locally (no DB)
  if(hasConfig){
    // load firebase app + modules (modular SDK v9) dynamically
    const appPromise = import('https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js').then(m => m);
    const dbPromise = import('https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js').then(m => m);
    const authPromise = import('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js').then(m => m);

    Promise.all([appPromise, dbPromise, authPromise]).then(async ([appMod, dbMod, authMod]) => {
      const { initializeApp } = appMod;
      const { getDatabase, ref, onValue, runTransaction, get, child, set } = dbMod;
      const { getAuth, signInAnonymously, onAuthStateChanged } = authMod;

      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);

      // sign-in anonymously
      try{
        await signInAnonymously(auth);
      }catch(err){
        // if already signed in or blocked, continue -- onAuthStateChanged will still fire
        console.warn('Anonymous sign-in error (may be ok):', err.message || err);
      }

      // listen for auth state
      onAuthStateChanged(auth, async user => {
        if(user){
          currentUid = user.uid;
          console.log('Signed in uid:', currentUid);
          // check whether this uid already voted
          try {
            const voteSnap = await get(child(ref(db), `poll/votes/${currentUid}`));
            if(voteSnap && voteSnap.exists()){
              // user already voted
              const recorded = voteSnap.val();
              showVoted(recorded.option);
            } else if(hasVotedLocal){
              // localStorage says voted but DB doesn't have record yet; mark UI voted anyway
              showVoted(null);
            } else {
              // not voted
              enableButtons(true);
            }
          } catch(e){
            console.error('Error checking vote record:', e);
            enableButtons(true);
          }
        } else {
          // no user yet
          enableButtons(true);
        }
      });

      // setup realtime counts listener
      const countsRef = ref(db, 'poll/counts');
      onValue(countsRef, snap=>{
        updateLocalResults(snap.val() || {});
      }, err => console.error(err));

      // show existing results area if any changes (onValue will call updateLocalResults)
      // done above

      // helper to cast a vote (only when uid present)
      async function castVote(uid, option){
        if(!db) return;
        // guard
        if(!OPTIONS.includes(option)) return;

        const userVoteRef = ref(db, `poll/votes/${uid}`);
        const optCountRef = ref(db, `poll/counts/${option}`);

        try {
          // write user vote (non-transactional) then increment count transactionally
          await set(userVoteRef, { option: option, ts: Date.now() });
          // increment count
          await runTransaction(optCountRef, (c) => (c || 0) + 1);
          // set local marker
          localStorage.setItem('poll_voted', '1');
          showVoted(option);
        } catch(err){
          console.error('Vote failed:', err);
          alert('Vote failed. Try again.');
        }
      }

      // expose castVote to button handler below by binding to closure
      window._castVote = castVote;

    }).catch(err=>{
      console.error('Firebase load error', err);
      enableButtons(true);
    });
  } else {
    console.warn('Firebase config not provided. DB disabled.');
    enableButtons(true);
  }

  // Button click handlers (works even before auth completes)
  buttons.forEach(b=>{
    b.addEventListener('click', async (e)=>{
      const opt = b.getAttribute('data-option');
      // local guard
      if(localStorage.getItem('poll_voted')){
        showVoted(null);
        return;
      }
      // if using DB/auth and cast function available, use it
      if(window._castVote && currentUid){
        // disable buttons immediately to prevent double-click
        enableButtons(false);
        await window._castVote(currentUid, opt);
        return;
      }
      // fallback: if DB not configured, increment local counters only (for demo)
      incrementLocalFallback(opt);
      localStorage.setItem('poll_voted','1');
      showVoted(opt);
    });
  });

  // Refresh button
  refreshBtn.addEventListener('click', async ()=>{
    if(!db){
      alert('Realtime DB not configured.');
      return;
    }
    // manual get of counts
    const dbMod = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js');
    const { get, ref, child } = dbMod;
    try{
      const snap = await get(child(ref(db), 'poll/counts'));
      updateLocalResults(snap.val() || {});
    }catch(e){
      console.error(e);
    }
  });

  // show voted message & disable vote buttons
  function showVoted(option){
    votedMsg.style.display = 'flex';
    if(option) votedText.textContent = `You've already voted (${option}). Thank you!`;
    else votedText.textContent = `You've already voted. Thank you!`;
    enableButtons(false);
  }

  // enable/disable vote buttons
  function enableButtons(enable){
    buttons.forEach(b=>{
      b.disabled = !enable;
      b.style.opacity = enable ? 1 : 0.6;
      b.style.cursor = enable ? 'pointer' : 'default';
    });
  }

  // update UI with counts
  function updateLocalResults(data){
    // data might look like { Green: 3, Blue: 1, ... }
    let total = 0;
    OPTIONS.forEach(k => total += (data && data[k]) ? Number(data[k]) : 0);
    votesText.textContent = 'Votes: ' + total;

    resultsArea.innerHTML = '';
    OPTIONS.forEach(k=>{
      const count = (data && data[k]) ? Number(data[k]) : 0;
      const percent = total ? Math.round((count / total) * 100) : 0;
      const row = document.createElement('div');
      row.className = 'result-row';
      row.innerHTML = `
        <div style="min-width:120px">${k}</div>
        <div style="display:flex;align-items:center;gap:8px;flex:1">
          <div class="bar" aria-hidden><i style="width:${percent}%"></i></div>
          <div style="min-width:48px;text-align:right">${count} (${percent}%)</div>
        </div>`;
      resultsArea.appendChild(row);
    });
    resultsArea.style.display = 'block';
  }

  // local fallback increments (only for demo if DB not present)
  function incrementLocalFallback(opt){
    const key = 'local_counts';
    const raw = localStorage.getItem(key);
    const obj = raw ? JSON.parse(raw) : {};
    obj[opt] = (obj[opt] || 0) + 1;
    localStorage.setItem(key, JSON.stringify(obj));
    updateLocalResults(obj);
  }

  // on load: if localStorage says voted, show message already
  if(hasVotedLocal){
    showVoted(null);
  } else {
    // keep buttons disabled initially until auth check completes (if using DB)
    if(hasConfig) enableButtons(false);
  }

  // initial empty results (until DB onValue loads)
  updateLocalResults({});
</script>
<!-- ===== Paste this BEFORE </body> ===== -->
<script type="module">
  // --------- 1) Add your firebaseConfig here (replace placeholders) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBRxGX2ySr1gwNP2I728IGXwTWzBTxGGlk",
    authDomain: "poll-ysr.firebaseapp.com",
    databaseURL: "https://poll-ysr-default-rtdb.firebaseio.com/",
    projectId: "poll-ysr",
    storageBucket: "poll-ysr.firebasestorage.app",
    messagingSenderId: "724261938489",
    appId: "1:724261938489:web:7d8f908dc8ade2698b74e8" 
  };

  // --------- 2) Import Firebase modules (CDN) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    runTransaction,
    get,
    child,
    set
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

  // --------- 3) Initialize ----------
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // --------- 4) Helper: generate or get persistent voter id (localStorage) ----------
  function getVoterId() {
    let id = localStorage.getItem('voterId');
    if (!id) {
      id = 'v-' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
      localStorage.setItem('voterId', id);
    }
    return id;
  }
  const voterId = getVoterId();

  // --------- 5) Basic DOM helpers (edit selectors to match your HTML) ----------
  // Update these selectors to match your buttons / elements
  const voteButtons = document.querySelectorAll('.vote-btn'); // add class 'vote-btn' to each option button
  const alreadyMsg = document.getElementById('already-voted-msg'); // element that shows "You've already voted"
  const votesCountEls = document.querySelectorAll('[data-vote-count]'); // optional: elements to display counts

  // disable voting UI
  function disableVotingUI() {
    voteButtons.forEach(b => { b.disabled = true; b.classList.add('disabled'); });
    if (alreadyMsg) alreadyMsg.style.display = 'block';
  }

  // enable voting UI
  function enableVotingUI() {
    voteButtons.forEach(b => { b.disabled = false; b.classList.remove('disabled'); });
    if (alreadyMsg) alreadyMsg.style.display = 'none';
  }

  // --------- 6) Check if user already voted on load ----------
  async function checkAlreadyVoted() {
    try {
      const voterRef = ref(db, 'voters/' + voterId);
      const snap = await get(voterRef);
      if (snap.exists()) {
        // already voted
        disableVotingUI();
        return true;
      } else {
        enableVotingUI();
        return false;
      }
    } catch (err) {
      console.error('DB read error', err);
      // if DB error, leave UI enabled but you may warn
      enableVotingUI();
      return false;
    }
  }

  // --------- 7) Vote function (safe increment using transaction) ----------
  // optionId should be like "green", "blue" etc. Matches your DB structure: /votes/{optionId}
  async function vote(optionId) {
    // first double-check local voters node
    const voterRef = ref(db, 'voters/' + voterId);
    const voterSnap = await get(voterRef);
    if (voterSnap.exists()) {
      disableVotingUI();
      return; // already voted
    }

    // run transaction on vote count
    const optionRef = ref(db, 'votes/' + optionId);
    try {
      await runTransaction(optionRef, (current) => {
        return (current || 0) + 1;
      });
      // mark the voter (so next time they cannot vote)
      await set(voterRef, { votedAt: Date.now(), option: optionId });
      disableVotingUI();
      // optionally update UI counts (you can call a refresh function)
      await refreshCounts();
    } catch (err) {
      console.error('Vote error', err);
      alert('Failed to send vote. Try again.');
    }
  }

  // --------- 8) Refresh counts on UI (reads /votes) ----------
  async function refreshCounts() {
    try {
      const rootRef = ref(db);
      const snap = await get(child(rootRef, 'votes'));
      if (!snap.exists()) return;
      const data = snap.val(); // object { green: 10, blue: 5, ... }
      // update elements with data-vote-count="green" etc.
      votesCountEls.forEach(el => {
        const key = el.getAttribute('data-vote-count');
        if (data[key] !== undefined) el.textContent = data[key];
      });
    } catch (err) {
      console.error('refreshCounts error', err);
    }
  }

  // --------- 9) Hook buttons ----------
  voteButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const option = btn.getAttribute('data-option'); // give each button data-option="green"
      if (!option) return;
      btn.disabled = true;
      vote(option);
    });
  });

  // --------- 10) Start: check and refresh initial counts ----------
  (async () => {
    const already = await checkAlreadyVoted();
    await refreshCounts();
  })();

</script>
<!-- ===== end paste ===== -->

</body>
</html>
